# Amazon S3にファイルを保存してみよう

## 概要

このハンズオンでは、AWSマネジメントコンソールを通した
Amazon Simple Storage Service (Amazon S3)の使用を行います。

Amazon S3はインターネットからアクセス可能なネットワークストレージです。
Amazon S3を使用すると、ウェブ上のあらゆる場所からでも、
いつでも必要な量のデータを保存して取得することができます。

## 目的

このハンズオンでは、以下のことを行います。

- Amazon S3でバケットを作成する
- バケットにオブジェクトを追加する
- オブジェクトを操作する
- バケットを削除する

## 全体図

![構成図](./images/handson01_structures.png "構成図")

## AWSマネジメントコンソールにアクセスする

1. [AWSのWebサイト](https://aws.amazon.com/jp/)にアクセスし、
    サイト右上にある「コンソールへログイン」をクリックします。
2. ログイン画面です。IAMユーザは「アカウント」には「アカウントID」を入れ、ユーザとパスワードにはIAMユーザのユーザ名とパスワードを入力します。
    ルートアカウントは、ユーザ名にルートアカウントのメールアドレスを入れ、パスワードにはルートアカウントのパスワードを入れます。
    必要事項を入力したら、「サインイン」をクリックします。
    - 多要素認証が有効な場合は、次の画面で認証トークンを入力します。
3. AWSマネジメントコンソールのトップページが開いたら完了です。

## 作業1: Amazon S3バケットを作成する

まずはAmazon S3バケットを作成します。
Amazon S3のすべてのオブジェクトはバケットに保存されます。

1. AWSマネジメントコンソールで「サービス」から「S3」をクリックします。
2. 「バケットを作成する」をクリックします。
    「バケット作成」ダイアログボックスが表示されます。
3. 「名前とリージョン」ページで、以下のように設定します。
    - バケット名: jawsug-niigata-20190126-NUMBER
        - NUMBERを適当なランダムな番号に置き換えてください。
    - リージョン: 「アジアパシフィック (東京)」を選択してください

    東京リージョンを選択すれば、日本からのアクセスに対しては低レイテンシでアクセスでき、また規制要件などにも対応できます。
    オレゴンリージョンなど他のリージョンも選択でき、リージョンによっては東京リージョンより安価に利用できます。
    明示的に別のリージョンに移動する場合を除き、リージョンに保存されたオブジェクトが他のリージョンへ移動することはありません。

    「既存のバケットから設定をコピー」オプションを使用すると、
    別のバケットと同じ設定を使用するバケットを簡単に作成できます。
    今回はこのオプションを使用しません。

4. 「作成」をクリックします。
    初期設定の状態でバケットを作成する事ができます。
    - "The requested bucket name is not available"で始まるエラーが表示された場合は、すでに同じバケット名が世の中に存在していることを示しています。最初の「Edit」リンクをクリックしてバケット名を変更して再度作成してください。

    S3バケット一覧には、先ほど作成したバケット名が表示されています。
    「アクセス」項目欄には「バケットとオブジェクトは非公開」となっており、初期設定ではオブジェクトはインターネットに公開されません。

## 作業2: オブジェクトをバケットにアップロードする

バケットの作成が完了し、オブジェクトを保存する準備が整いました。
テキストファイルや画像ファイル、動画ファイル、zipファイルなど、
様々な種類のファイルをオブジェクトとして保存することができます。

Amazon S3にオブジェクトを追加する際、
オブジェクトと共にメタデータを含めてオブジェクトへのアクセスをコントロールする
アクセス許可を設定するオプションがあります。

この作業では、S3バケットにオブジェクトをアップロードして、
S3バケットにオブジェクトを保存します。

1. 右にあるリンクを右クリックして、画像ファイルをダウンロードします。
    [bicycle.jpg](./obj/bicycle.jpg)
2. S3バケット一覧で、先ほど作成した「jawsug-niigata-*」で始まる
    バケット名をクリックします。
3. 「アップロード」をクリックします。
    - ファイルのアップロードウィザードが起動します。
        このウィザードを使用すると、ファイルを選択するか、
        S3ウィンドウにドラッグすることで、ファイルをアップロードできます。
4. 「アップロード」ダイアログボックスで「ファイルの追加」をクリックします。
5. 先ほどダウンロードした画像ファイルを参照して、選択します。
6. 「アップロード」をクリックします。
    - アップロードの進行状況は、画面下部にある転送状態を示すパネルで確認できます。
        ファイルのサイズが非常に小さいと、転送が表示されない場合があります。
        ファイルがアップロードされると、バケットに表示されます。

## 作業3: フォルダを作成して、オブジェクトを移動する

Amazon S3には、バケット配下にオブジェクトが格納されるフラットな構造のため、
サブバケットやサブディレクトリのような階層はありません。
しかし、オブジェクトキー名にプレフィックスや区切り記号を使用して、
論理的な階層を示すことができます。
これによって、マネジメントコンソール上ではフォルダの概念をサポートしています。

ここでは、マネジメントコンソール上でフォルダを作成し、
作成したフォルダに先ほどアップロードしたファイルを移動します。

1. S3バケット一覧で、先ほど作成した「jawsug-niigata-*」で始まる
    バケット名をクリックします。
2. 「フォルダの作成」をクリックします。
3. 必要事項を入力します。
    - *新しいフォルダ*: フォルダ名を入力します。
        ここでは「images」とします。
    - 暗号化オプションは「なし (バケット設定を使用)」の初期設定のままにします。
4. 「保存」をクリックします。
    - 「images」フォルダが作成できました。
5. 先ほどアップロードした画像ファイルの左側のチェックボックスにチェックを入れます。
6. 「アクション」⇒「切り取る」をクリックします。
7. 先ほど作成した「images」フォルダをクリックします。
8. 「アクション」⇒「貼り付ける」をクリックします。
    - 「コピーアンドペースト」ダイアログ画面が表示されます。
9. 内容を確認し「貼り付ける」をクリックします。

移動に成功すると、imagesフォルダ内に画像が移動していることがわかります。
ただし、S3のバケット内のオブジェクトはフラットな構造であるため、
正確にはオブジェクトのキーが「images/」のプレフィックスで始まるようになっただけです。

## 作業4: オブジェクトを削除する

オブジェクトを削除してみましょう。

1. S3バケット一覧で、先ほど作成した「jawsug-niigata-*」で始まる
    バケット名をクリックします。
2. 「images」フォルダをクリックします。
3. 画像ファイルの左側のチェックボックスにチェックを入れます。
4. 「アクション」⇒「削除」をクリックします。
    - 「オブジェクトの削除」ダイアログ画面が表示されます。
5. 内容を確認し「削除」をクリックします。

## 作業5: バケットを削除する

最後に、バケットを削除して後片付けをしましょう。
バケットを削除する際は、バケット内にオブジェクトがないことが必要です。
ただし、AWSマネジメントコンソール上での操作は、
バケット内にオブジェクトがあっても、バケットを削除することができます。

1. S3バケット一覧で、先ほど作成した「jawsug-niigata-*」で始まる
    バケット名の左側のチェックボックスにチェックを入れます。
2. 「削除」をクリックします。
    「バケットを削除する」ダイアログ画面が表示されます。
3. テキストボックスにバケット名を入力します。
4. 「確認」をクリックします。

バケットの削除が完了すると、バケット一覧からバケット名が無くなります。

以上です。
お疲れ様でした。

---

## バケット設定の補足

バケット作成時に、初期設定と異なる設定をすることができます。

1. 「バケットを作成する」をクリックします。
2. 必要事項を入力し、「次へ」をクリックします。
    「オプションの設定」ページが表示されます。
    初期設定を確認します。

    - バージョニング: チェックが入っていないことを確認します。
        - チェックを入れると、バージョニングが有効になります。
        - 参考: [S3バケットのバージョニングを有効または停止する方法](https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/user-guide/enable-versioning.html)
    - サーバーアクセスログの記録: チェックが入っていないことを確認します。
        - チェックを入れると、バケットにアクセスしたリクエストログを
            別のバケットに保存します。
        - 参考: [Amazon S3サーバアクセスのログ記録](https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/dev/ServerLogs.html)
    - Tags: タグを利用する事ができます。
        タグは例えば利用料を確認する際に、どのバケットがどれくらいコストがかかっているかなどを識別する事ができるようになります。
    - オブジェクトレベルのログ記録: チェックが入っていないことを確認します。
        - CloudTrailを使用して、オブジェクト単位でのアクセスログを記録します。
        - CloudTrailの料金が別途かかります。
        - 参考: [AWS CloudTrail データイベントで S3 バケットのオブジェクトレベルのログ記録を有効にする方法](https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/user-guide/enable-cloudtrail-events.html)
    - デフォルト暗号化: チェックが入っていないことを確認します。
        - チェックを入れると、オブジェクトを自動的に暗号化します。
        - 参考: [暗号化を使用したデータの保護](https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/dev/UsingEncryption.html)
    - 詳細設定
        - オブジェクトのロック: チェックが入っていないことを確認します。
            - チェックを入れると、オブジェクトの削除や更新ができなくなります。
            - バージョニングされたバケットでのみ機能します。
            - 参考: [Amazon S3 Object Lock のご紹介](https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/dev/object-lock.html)
    - CloudWatch リクエストメトリクス: チェックが入っていないことを確認します。
        - チェックを入れると、CloudWatchを使用してバケットのリクエストとデータ転送をモニタリングできます。
        - CloudWatchの料金が別途かかります。
        - 参考: [Amazon CloudWatchを使用したメトリクスのモニタリング](https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/dev/cloudwatch-monitoring.html)

3. 「次へ」をクリックします。
    「アクセス許可の設定」ページが表示されます。
    初期設定ではパブリックアクセスが禁止されています。

    - このバケットのパブリックアクセスコントロールリスト(ACL)を管理する
        - 基本的な読み書きの権限を、他のAWSアカウントに付与するために使用します。
        - 新規のパブリックACLと、パブリックオブジェクトのアップロードをブロックする
            - 有効化すると、新規にパブリックACLを追加することを防いだり、
                パブリックオブジェクトをアップロードすることを防ぐことができます。
        - パブリックACLを通じて付与されたパブリックアクセスを削除する
            - 有効化すると、パブリックACLによって権限を付与されたパブリックアクセスを防ぎます。
    - このバケットのパブリックバケットポリシーを管理する
        - バケットポリシーはJSONベースで表記され、高度なアクセス権限を設定できます。
        - 新規のパブリックバケットポリシーをブロックする
            - 有効化すると、新規にパブリックバケットポリシーを設定することを防ぎます。
        - バケットにパブリックポリシーがある場合、パブリックアクセスとクロスアカウントアクセスをブロックする
            - 有効化すると、パブリックアクセス権限が付与されたバケットであっても、バケット所有者とAWSサービスのみに限定させることができます。
    - システムのアクセス許可の管理
        - S3バケットのサーバアクセスログの記録先のバケットに設定する場合は、「Amazon S3ログ配信グループにこのバケットへの書き込みアクセス権限を付与する」を選択します。

4. 「次へ」をクリックします。
    「確認」ページが表示されます。

5. 内容を確認して、「バケットを作成」をクリックします。
    これでバケットが作成されます。
    - "The requested bucket name is not available"で始まるエラーが表示された場合は、すでに同じバケット名が世の中に存在していることを示しています。最初の「Edit」リンクをクリックしてバケット名を変更して再度作成してください。

## オブジェクト設定の補足

オブジェクトのアップロードの際にも、初期設定と異なる設定をすることができます。

1. 「アップロード」をクリックします。
2. アップロードするファイルを選択し、「次へ」をクリックします。
    「アクセス許可を設定する」ページが表示されます。
    初期設定ではパブリックアクセスが禁止されています。

    - ユーザーを管理:
        所有者に対してオブジェクトの読み書きと
        オブジェクトACLへの読み書きの権限が付与されています。
    - パブリックアクセス許可を管理する:
        「このオブジェクトにパブリック読み取りアクセス権限を付与しない (推奨)」になっています。

3. 「次へ」をクリックします。
    「プロパティを設定する」ページが表示されます。
    初期設定を確認します。

    - ストレージクラス:
        「スタンダード」になっています。
        基本的に「スタンダード」を指定すれば問題ありません。
        アクセスが少なく、しばらく保存する必要のあるオブジェクトに対しては、
        適切なストレージクラスを選択することができます。
    - 暗号化:
        オブジェクト単位で暗号化のキーを指定できます。
        バケットにデフォルトの暗号化を設定している場合、「なし」を選択するとバケットのデフォルト暗号化設定に従います。
    - メタデータ:
        メタデータを別途設定出来ます。
        オブジェクトメタデータは一旦アップロードすると変更できません。
    - タグ:
        オブジェクト単位でタグを設定できます。

4. 「次へ」をクリックします。
    「確認」ページが表示されます。

5. 内容を確認して、「アップロード」をクリックします。
